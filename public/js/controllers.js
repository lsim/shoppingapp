// Generated by CoffeeScript 1.6.3
(function() {
  'use strict';
  define(['app'], function(app) {
    var ListItem, ShoppingListCtrl, idCounter;
    idCounter = 0;
    ListItem = function(item, isNew) {
      this.isNew = isNew;
      this.text = item.text;
      return this._id = !isNew ? item._id : 'tmpId' + idCounter++;
    };
    ShoppingListCtrl = function($scope, listAPIService, confirmService, $timeout) {
      var handleSse, listenerListId, mergeChanges, registerForSse, sendNewItems, sendPendingDeletions, sseSource;
      $scope.newItem = {
        text: ''
      };
      $scope.deletionFilter = function(item) {
        return !item.isDeleted;
      };
      $scope.addItem = function() {
        if (!$scope.newItem.text) {
          return;
        }
        $scope.list.items.push(new ListItem({
          text: $scope.newItem.text
        }, true));
        $scope.newItem.text = '';
        return sendNewItems();
      };
      sendPendingDeletions = function() {
        var deletees;
        deletees = _.filter($scope.list.items, function(item) {
          return item.isDeleted;
        });
        return deletees.length && listAPIService.deleteItems(deletees.map(function(item) {
          return item._id;
        }), $scope.list._id, $scope.list.version);
      };
      sendNewItems = function() {
        var newItems;
        newItems = _.filter($scope.list.items, function(item) {
          return item.isNew;
        }).map(function(item) {
          return {
            text: item.text
          };
        });
        return newItems.length && listAPIService.addItems(newItems, $scope.list._id, $scope.list.version);
      };
      $scope.deleteItem = (function() {
        var doDelete;
        doDelete = function(deletee) {
          if (deletee.isNew) {
            return $scope.list.items = _.filter($scope.list.items, function(item) {
              return item._id !== itemId;
            });
          } else {
            deletee.isDeleted = true;
            console.debug('isDeleted set to true on item,items,phase ', deletee, $scope.list.items, $scope.$$phase);
            return sendPendingDeletions();
          }
        };
        return function(item) {
          return confirmService.yesNoConfirm('Delete item?', 'Are you sure you want to delete item "' + item.text + '"?').then(function() {
            return doDelete(item);
          });
        };
      })();
      mergeChanges = function(localList, serverList) {
        var deletedLocalItems, newLocalItems;
        newLocalItems = _.filter(localList, function(localItem) {
          return localItem.isNew && !_.some(serverList, function(serverItem) {
            return serverItem.text === localItem.text;
          });
        });
        deletedLocalItems = _.filter(localList, function(localItem) {
          return localItem.isDeleted;
        });
        serverList.filter(function(item) {
          return _.some(deletedLocalItems, function(deletedItem) {
            return item._id === deletedItem._id;
          });
        }).forEach(function(item) {
          return item.isDeleted = true;
        });
        return serverList.concat(newLocalItems);
      };
      $scope.getLatest = function() {
        return listAPIService.getLatest().then(function(data) {
          var serverList;
          if (data) {
            console.debug('Received fresh list ', data);
            serverList = data;
            serverList.items = serverList.items.map(function(item) {
              return new ListItem(item, false);
            });
            if ($scope.list && $scope.list.items) {
              serverList.items = mergeChanges($scope.list.items, serverList.items);
            }
            $scope.list = serverList;
            registerForSse($scope.list._id);
            return sendNewItems() || sendPendingDeletions();
          }
        });
      };
      handleSse = function(msg) {
        console.log('Received sse: ', msg);
        return $scope.$apply(function() {
          return $scope.getLatest();
        });
      };
      sseSource = null;
      listenerListId = null;
      registerForSse = function(listId) {
        if (listId === listenerListId) {
          return;
        }
        if (sseSource) {
          console.log('Unregistering old listener');
          sseSource.removeEventListener('message', handleSse);
        }
        console.log('Registering new listener');
        sseSource = new EventSource('/update-stream/' + listId);
        listenerListId = listId;
        return sseSource.addEventListener('message', handleSse, false);
      };
      return $scope.getLatest();
    };
    ShoppingListCtrl.$inject = ['$scope', 'listAPIService', 'confirmService', '$timeout'];
    return app.module.controller('ShoppingListCtrl', ShoppingListCtrl);
  });

}).call(this);
